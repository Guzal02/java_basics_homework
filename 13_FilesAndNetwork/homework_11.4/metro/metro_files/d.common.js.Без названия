$.fn.cssINT = function(p){var v = $(this).css(p);return typeof v=='string'?parseInt(v.replace('px','')): v;};$.fn.visibleWidth = function() {var t = $(this);if (!t.length) return 0;if(t.is(":hidden"))return 0;return t.width()+t.cssINT('paddingLeft')+t.cssINT('paddingRight')};$.fn.visibleHeight = function() {var t = $(this);if (!t.length) return 0;if(t.is(":hidden"))return 0;return t.height()+t.cssINT('paddingTop')+t.cssINT('paddingBottom')};eReport = function(msg,data) {console.warn(msg);console.log(data);if(document.domain.indexOf('www.moscowmap.ru')===-1){console.trace();alert(msg);throw '';};return null;};String.prototype.hashCode = function(){var hash = 0;for (var i = 0; i < this.length; i++) {var character = this.charCodeAt(i);hash = ((hash<<5)-hash)+character;hash = hash & hash;};return hash;};if (!window.MainLib) MainLib = {};MainLib.initAppendData = function(btn,mode) {var target_class=btn.attr('data-target'),box_class=btn.attr('data-target-box');if (!target_class) return;var target = btn.closest( target_class),target_box = !!box_class ? target.closest(box_class) : target,data_script=btn.attr('data-script'),data_load=btn.attr('data-load');if (!target.length || !(!!data_script) || !(!!data_load) ) return;var id=this.getJsConfig('page_obj_id')|| 0;btn.one('click',function(){btn.after('<i class="loader"></i>' ).remove();$.ajax({type: 'GET',url: '/services/'+data_script,dataType: 'html',async: false,data: { data:data_load, id: id, mode : mode },success: function(resp) {target_box.find('.loader').remove();if (!!resp) target.append(resp);BlockStatHandler && BlockStatHandler.init();target_box.css('height','auto');var new_btn=target.find('.js-append-data');if (new_btn.length) MainLib.initAppendData(new_btn.eq(0),mode)}})})};MainLib.trim = function(s) {return s ? s.replace(/(^\s+)|(\s+$)/g, "") : '';};MainLib.word_ok = function (n,o1,o3,o5) {n=parseInt(n);if (n>100) n=n%100;if (n>4 && n<21) return o5;if (n>20) n=n%10;if (n===0) return o5;if (n===1) return o1;if (n<5) return o3;return o5;};MainLib.datakey = function (e){var x=e.keyCode;return (x===0 || x===8 || x===32 || x===46 || x===188 || x===190 || x>47 && x<58 || x>64 && x<91 || x===229 )? true : false;};MainLib.stripTags = function(html) {var tmp=document.createElement("DIV");tmp.innerHTML = html;return tmp.textContent||tmp.innerText;};MainLib.stripSlashes = function(str) {return str.replace(/\0/g, '0').replace(/\\(.)/g, "$1")};MainLib.post = function(url, data) {var code = '<form action="'+ url + '" method="post" id="tmpform">';for (var key in data)code+= '<input type="hidden" name="' + key +'" value="'+ data[key] +'">';code+='</form>';$('body').append(code);$('#tmpform').submit()};MainLib.replaceQuotes = function(str) {return str.replace(new RegExp("\'",'g') ,'"')};MainLib.group_import_xhr = {};MainLib.group_import_key = null;MainLib.importAbort = function(key) {MainLib.group_import_xhr[key] && MainLib.group_import_xhr[key].abort()};MainLib.timeKey = function(salt){var d = new Date();return d.getTime()+d.getUTCMilliseconds()+(salt || '')};MainLib.importSrcGroup = function(urlset,callback,key) {if(typeof urlset !=='object'){eReport('MainLib.importSrcGroup: urlset must be array',urlset);return;};var url = urlset[0];if(typeof url !=='string'){eReport('MainLib.importSrcGroup: urlset elems must be string',url);return;};if (!key) key = MainLib.timeKey(url);var method = MainLib.importJSON;if (url.match(/\.js(\?|$)/i)) method = MainLib.importJS;else if (url.match(/\.css(\?|$)/i)) method = MainLib.importCSS;else if (url.match(/#html$/)) {method = MainLib.importHTML;url=url.replace(/#html$/,'')};var count = urlset.length;if (count===1) {MainLib.group_import_xhr[key] = method(url,callback)} else {var urlset_new = urlset.slice(1,count);var callback_new = function(){MainLib.importSrcGroup(urlset_new,callback,key)};MainLib.group_import_xhr[key] = method(url,callback_new)}};MainLib.importJsQueue = function(urlset,defset,replay_count) {var url = urlset[0];var def = defset[0];if (urlset.length===1) {MainLib.importJS(url).then(function(){def.resolve()},function(){def.reject()})} else {MainLib.importJS(url).then(function(){def.resolve();MainLib.importJsQueue(urlset.slice(1),defset.slice(1),replay_count)},function(){if (replay_count>0) {MainLib.importJsQueue(urlset,defset,replay_count-1)} else {for (var i in defset) defset[i].reject()}})}};MainLib.reformatSrcSet = function(src_set) {var result = {};for(var x in src_set) {var item = src_set[x];result[item.type] = result[item.type] || [];result[item.type].push(item.src)};return result;};MainLib.importSrcGroup4 = function(urlset) {var defset = [];var defset_js = [];for (var section in urlset) {for (var i in urlset[section]) {var url = urlset[section][i];if(section==='js'){var def = new $.Deferred();defset_js.push(def)} else {var def = MainLib.importCSS(url)};defset.push(def)}};if(defset_js.length)MainLib.importJsQueue(urlset['js'],defset_js,3);return $.when.apply(null,defset)};MainLib.importJS = function(url,callback, no_async) {return $.ajax({url: url,dataType: 'script',cache: true,async : no_async ? false : true,success: callback,error: function(xhr,msg){console.log('ошибка загрузки',xhr,msg,url)}})};MainLib.importJSON = function(url,callback,data) {return $.ajax({url: url,data : data,dataType: 'json',cache: true,async : true,success: callback,error: function(xhr,msg){ eReport(msg,url)}})};MainLib.importHTML = function(url,callback,data) {return $.ajax({url: url,dataType: 'html',data: data,cache: true,async : true,success: callback,error: function(xhr,msg){ eReport(msg,url)}})};MainLib.importCSS = function (url,callback){return $.ajax({url: url,dataType: 'html',cache: true,async : true,success: function(resp){$('head').append('<style>'+resp+'</style>');callback && callback()},error: function(xhr,msg){console.log('MainLib.importCSS, url=',url);eReport(msg)}})};MainLib.json2str = function(obj){return encodeURIComponent(JSON.stringify(obj))};MainLib.str2json = function(str){var str = decodeURIComponent(str);str=str.replace(/\+/g,' ');return JSON.parse(str)};MainLib.geoDegree = function (x) {var grad={g:0,m:0,s:0};var gms=parseFloat(x);grad.g=Math.floor(gms);var ms=(gms-grad.g)*60;grad.m=Math.floor(ms);var s=(ms -grad.m)*60;grad.s=Math.round(s);return grad.g+'°'+(grad.m || grad.s?grad.m+'΄'+(grad.s?grad.s+'˝' : ''): '')};MainLib.getJsConfig = function(key1,key2) {if(typeof $jsconfig=='undefined')return null;if(typeof $jsconfig[key1]=='undefined')return null;if (!key2) return window.$jsconfig[key1];if(typeof $jsconfig[key1][key2]=='undefined')return null;return $jsconfig[key1][key2];};MainLib.setJsConfig = function(value,key1,key2) {if(typeof $jsconfig=='undefined')window.$jsconfig={};if (key2) {$jsconfig[key1] = $jsconfig[key1] || {};if(typeof $jsconfig[key1]!='object'){eReport('$jsconfig['+key1+'] is not object');return this;};$jsconfig[key1][key2] = value;} else {$jsconfig[key1] = value;};return this;};MainLib.delJsConfig = function(key) {if(typeof $jsconfig=='undefined')window.$jsconfig={};else $jsconfig[key] = null;return this;};MainLib.getExternalJsonData = function(filename,handler) {if (!this.storage4extdata) this.storage4extdata = {};if (this.storage4extdata[filename]) return this.storage4extdata[filename];var result = null;$.ajax( {url: filename,dataType: 'json',cache: true,async : false,success: function(data) { result = data; }});if (handler) result = handler(result);this.storage4extdata[filename] = result;return result;};MainLib.toMobile = function(){$.get('/remotes/switch-dev-mode?mode=mobile',function(){location.reload()})};MainLib.updateAdfox = function (top_elem) {var ads=$('body div[id^=adfox]');if (!ads.length) return false;var snap_top=top_elem?top_elem.getBoundingClientRect()['top']: 0;ads.each(function(){var t = $(this);var id=t.attr('id');var ad_top=top_elem?t[0].getBoundingClientRect()['top']: 0;var is_bobber=t.closest('.b-ad-bobber').length;if (top_elem && !is_bobber && ad_top < snap_top) {console.log(id, ad_top, snap_top);return true;};if(t.height()&& window['Ya']){window['Ya']['adfoxCode'].reload(id);console.log(id+'-upd')} else {console.log(id+'-0')}})};MainLib.checkAutorized = function(){var result = false;$.ajax( {url: '/remotes/user-check-autorized',dataType: 'json',cache: false,async : false,success: function(data) { result = data; }});return result;};MainLib.loadContent = function(xhr, data, mode, callback){if (xhr) xhr.abort();var on_error = function(){var resp='ошибка получения данных';callback(resp)};data.mode = mode;data.search = location.search;return $.ajax({url: '/services/onmap-info',data: data,dataType: "html",async: true,cache: true,error: on_error,success: function(resp){if (!resp) on_error();else callback(resp)}})};$(function(){$('.js-howtoget-details').on('click',function(){var table_id=$(this).attr('data-table');var target_data=MainLib.getJsConfig('howtoget_target_data');location.href='/howtoget-details.php?id='+table_id+'&target='+encodeURI(JSON.stringify(target_data))})});MainLib.getCookie = function(name) {var matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));return matches ? decodeURIComponent(matches[1]) : undefined;};MainLib.setCookie = function(name, value, options) {options.path=options.path || '/';if (options.expires) options.expires = options.expires.toUTCString();var updatedCookie=encodeURIComponent(name)+"="+encodeURIComponent(value);for (var optionKey in options) {updatedCookie+="; "+optionKey;var optionValue = options[optionKey];if (optionValue !== true) {updatedCookie+="="+optionValue;}};document.cookie = updatedCookie;};MainLib. deleteCookie = function(name) {MainLib.setCookie(name, "", {'max-age': -1})};MainLib.getJsonFromCookie = function(name, clear_flag) {var data = MainLib.getCookie(name);if (!data) return null;if (clear_flag) MainLib.deleteCookie(name);data = JSON.parse(data);if(typeof data !='object')return null;return data;};MainLib.setJsonToCookie = function(name, data, age_second) {if(typeof data !='object')return;data = JSON.stringify(data);MainLib.setCookie(name,data,{'max-age': age_second})};MainLib.setCookie4AlertOnNewPage = function(msg,header){var cook_data = {msg : msg,header : header,class: 'modal_confirm'};MainLib.setJsonToCookie('alert-on-new-page',cook_data,{'max-age':20})};MainLib.getCookie4AlertOnNewPage = function(){return MainLib.getJsonFromCookie('alert-on-new-page',true)};MainLib.getScrollTop = function($elem, with_page_offset){return $elem[0].getBoundingClientRect()['top']+(with_page_offset?window.pageYOffset : 0)};MainLib.round = function(value,n) {return parseFloat(value.toFixed(n))};AutocompleteHandler = {names : {class_main : 'js-autocomplete',class_ready : 'autocomplete-is-ready',class_show : 'autocomplete-open',class_init : 'autocomplete-is-init',class_scroll : 'autocomplete-scrollable',attr_logic : 'data-autocomplete-logic',attr_preset : 'data-autocomplete-preset',attr_data : 'data-object'},common_cache : [],collection : [],init : function() {var that = this;$('.'+this.names.class_main).not('.'+this.names.class_ready).addClass(this.names.class_ready).one('click',function(e){var num = that.collection.length;that.collection[num] = new that.AC(that,$(this),num);$(e.target).click().focus()})},AC : function(parent,elem,num) {this.parent = parent;this.parent_elem = elem;this.num = num;this.logic = elem.attr(parent.names.attr_logic);if(!this.logic)return eReport('attr_logic is not defined');this.input=elem.find('input').eq(0);if(!this.input.length)return eReport('child input is not exists');var preset = elem.attr(parent.names.attr_preset);this.addPreset(preset);this.addInputEvents()}};AutocompleteHandler.AC.prototype = {parent: null,parent_elem: null,logic: null,input: null,timeout : 0,xhr : null,response_data : null,layers : null,preset : null,snap_data : null,preset_default : {classes : 't-autocomplete-snap',scroll : 0,minlen: 2,delay : 500,show_allink : 0,autotransfer : false,autoopen: null,trigger : null,disable: false},addInputEvents : function () {var that = this;this.input.on('focus',function(){if (that.preset.disable) { that.input.blur(); return; };if (!that.val() && that.preset.autoopen) that.searchBegin(that.preset.autoopen)}).on('blur',function(){that.searchBreak()}).on('keydown',function(e){if (MainLib.datakey(e)) {that.searchBreak();that.saveItemData('')}}).on('keyup',function(e){if (MainLib.datakey(e)) {that.searchBreak();that.timeout = setTimeout( function(){ that.searchBegin()}, that.preset.delay )}})},addPreset : function(preset) {preset = preset ? JSON.parse(preset.replace(/'/g,'"')) : {};if(typeof preset !='object')return eReport('bad preset');this.preset = {};$.extend(this.preset, this.preset_default, preset)},close : function() {this.searchBreak();this.layers.ul && this.layers.ul.hide();this.removeCloseEvent()},show: function() {if (this.layers.ul) {this.layers.ul.show();this.addCloseEvent()}},val : function(value) {if (value==null) return MainLib.trim(this.input.val());this.input.val(value);this.input.change();return this;},searchBegin : function () {this.searchBreak();var val = this.val();if (val && val.length>=this.preset.minlen) {this.search(val)} else {if (this.preset.autoopen) this.search(this.preset.autoopen)}},searchBreak : function () {if (this.xhr) this.xhr.abort();if (this.timeout) clearTimeout(this.timeout);return this;},response : function (items) {this.renderLayers();if (items.length) this.renderItems(items).show();else this.close()},renderLayers : function(){if (this.layers && this.layers.ul) return this;this.layers = {};this.parent_elem.append('<div class="'+ this.preset.classes +' js-autocomplete-layer"><ul></ul></div>');this.layers.snap=this.parent_elem.find('.js-autocomplete-layer').eq(0);this.layers.ul=this.layers.snap.find('ul').eq(0);if (this.preset.scroll) {this.layers.ul.addClass(this.parent.names.class_scroll).css('max-height',this.preset.scroll+'px')};this.addSelectEvent();return this;},addSelectEvent : function(){var that = this;this.layers.ul.on('click','li',function(event){var name=$(this).attr('data-value');var i=parseInt($(this).attr('data-index'));var data=that.response_data[i]|| '';if(name==='all_link'){location.href=ProjectHandler.getSearchUri(that.val(),'super',true);return true;};if (that.preset.autotransfer && data.url) {location.href = data.url;return true;};that.val(name);that.saveItemData(data);that.close();if (that.preset.trigger) that.input.trigger(that.preset.trigger)})},addCloseEvent: function() {var that = this;$(document).on('mouseup.ac',function(e){if (!that.parent_elem.is(e.target) && that.parent_elem.has(e.target).length === 0) {that.close()}});$(document).on('keydown.ac',function(e){if (e.keyCode===27) that.close()});$(window).on('scroll.ac',function(){that.close()});$(window).on('resize.ac',function(){that.close()})},removeCloseEvent : function(){$(document,window).off('.ac')},renderItems : function(items) {var output='';this.response_data = {};for (var i in items) {var item = items[i];output+='<li'+ ' data-value="' + item.value + '"'+ ' data-index="' + i + '"'+'>'+ item.label+'</li>';this.response_data[i] = item.data;};this.layers.ul.html(output);return this;},saveItemData: function(data) {var a = this.parent.names.attr_data;data=data?MainLib.json2str(data): '';this.input.attr(a,data)},prepareItemsData : function (data) {var output = [];for (var i in data) {var name=data[i].name+'';var value=name.replace(/<?@>?/g,'').replace(/\s*\[.*$/,'');var label=name.replace(/@>/gi,'<span>').replace(/<@/gi,'</span>');output.push({ label : label,value : value,data : {id: parseInt(data[i].id),url: data[i].url,type: data[i].type,name: value}})};if (this.preset.show_allink && output.length>=this.preset.show_allink) output.push({label : 'найти все совпадения',value : 'all_link'});return output;},loadFromCache : function(key) {return this.parent.common_cache[key];},saveToCache: function(key,resp){this.parent.common_cache[key] = resp;},search : function (term) {term=MainLib.trim(term.replace(/[^а-яё0-9a-z,;\.\-\s\/]/gi,' ').replace(/\s{2,}/gi,' '));if (term.length < this.preset.minlen) {this.response([]);return;};var snap = this.snap_data;var data = {str: term ,snap : snap?JSON.stringify({id: snap.id,type: snap.type}): '',logic: this.logic};var cache_key=term+'|'+this.logic+(snap?'|'+snap.id+'|'+snap.type : '');var from_cache = this.loadFromCache[cache_key];if(typeof from_cache !='undefined'){this.response(from_cache);return;};var that = this;this.xhr = $.ajax({type: 'GET',url: '/services/search-ac',dataType: 'json',async: true,data: data,success: function (resp){resp = !!resp ? that.prepareItemsData(resp) : [];that.saveToCache(cache_key,resp);if (resp) that.response(resp)}})}};ClockHandler = {cookie_name: 'timestamp4clock',init : function() {this.filed_hours=$(".js-header-clock-h");this.filed_minutes=$(".js-header-clock-m");if (!this.filed_hours.length) return false;var that = this;var t = MainLib.getCookie(that.cookie_name);if (t) this.start(t, true);else $.ajax({type: "GET",url: "/services/single-2time2.php",dataType: "html",async: true,success: function(t){if (!t.match(/^\d+$/)) return false;that.start(t, false)}})},start : function(value, diff_mode) {if (this.timer) clearInterval(this.timer);this.timestamp_diff = parseFloat(value);this.now = new Date();if (!diff_mode) {this.timestamp_diff-= this.now.getTime();MainLib.setCookie(this.cookie_name,this.timestamp_diff,{'max-age': 3600*24})};this.secondTick();this.timer = setInterval(this.secondTick, 1000)},secondTick : function() {var that = ClockHandler;that.currTickTimeStamp = new Date().getTime();that.now.setTime(that.currTickTimeStamp + that.timestamp_diff);var h=ClockHandler.now.getUTCHours()+'';var m=ClockHandler.now.getUTCMinutes()+'';that.filed_hours.html(h.length <2?'0'+h : h);that.filed_minutes.html(m.length <2?'0'+m : m)}};DependHandler = {names : {control : 'js-toggle-depend',layer : 'js-depend',active_control : 's-depend-control-active',single_control : 's-depend-control-single',always_on : 's-depend-control-always-on',active : 's-depend-active',flag : 's-depend-is-init',attr_json : 'data-depend',attr_set : 'data-depend-set',attr_active_name : 'data-depend-active-name',attr_passive_name : 'data-depend-passive-name'},getTargets : function(val){var eq='=';var m = /^\^(.+)$/.exec(val);if (m) {eq='^=';val = m[1];};return $('.' + this.names.layer ).filter('[' + this.names.attr_set + eq + '"' + val +'"]')},doAction : function(action, target, is_active,def_control) {var a = this.names.active;var callbackControl = function() {def_control && def_control.resolve()};switch(true) {case action==='hide' :target.hide().removeClass(a);callbackControl();break;case action==='show' :target.show().addClass(a);callbackControl();break;case action==='toggle' :target.toggle().toggleClass(a);callbackControl();break;case action==='toggle-slide-size' && !is_active:case action==='toggle-slide-nth' && !is_active:var hmax=target.attr('data-max-height');var hmin=target.attr('data-min-height');var speed=target.attr('data-speed');if (!hmax) {hmin = target.height();target.addClass(a);if(action==='toggle-slide-nth')target.attr('data-depend-nth','');hmax = target.height();speed = Math.max(Math.min(500,hmax-hmin), 200);if(action==='toggle-slide-nth')target.css({'height' : hmin+'px','overflow' : 'hidden'});target.removeClass(a).attr('data-speed',speed).attr('data-max-height',hmax).attr('data-min-height',hmin)};target.animate({height: hmax+'px'},speed,'linear',callbackControl);break;case action==='toggle-slide-size' && is_active:case action==='toggle-slide-nth' && is_active:var hmin=target.attr('data-min-height');var speed=target.attr('data-speed');target.animate({height: hmin+'px'},speed,'linear',function(){target.removeClass(a);callbackControl()});break;case action==='toggle-slide' && !is_active:target.hide().addClass(a).slideDown('fast','linear',callbackControl);break;case action==='toggle-slide' && is_active:target.slideUp('fast','linear',function(){target.removeClass(a);callbackControl()});break;default:eReport('undefined case',action)}},toggleControl: function(control,is_active){var ac = this.names.active_control;var active_name = control.attr(this.names.attr_active_name);var passive_name = control.attr(this.names.attr_passive_name);if (!is_active && active_name) {control.attr(this.names.attr_passive_name,control.html());control.html(active_name)} else if (is_active && passive_name) {control.attr(this.names.attr_active_name,control.html());control.html(passive_name)};control.toggleClass(ac);var single_mode = control.hasClass(this.names.single_control);if (!single_mode) {var control_other=control.nextAll('.'+ac).add(control.prevAll('.'+ac));var fixed_for_cabinet_tree=control.closest('.b-cabinet-menu').find('.menu-section-title');if (fixed_for_cabinet_tree.length) control_other = control_other.add(fixed_for_cabinet_tree);if (control_other.length) control_other.removeClass(ac)}},init : function() {var class_flag = this.names.flag;var that = this;$('.'+this.names.control).not('.'+class_flag).addClass(class_flag ).on('click',function(){var a = $(this).attr(that.names.attr_json).replace(/'/g,'"');var data = JSON.parse(a);var control = $(this);var always_on = control.hasClass(that.names.always_on)|| data['toggle-slide-nth']|| data['toggle-slide']|| data['toggle-slide-size'];var is_active = control.hasClass(that.names.active_control);if (is_active && !always_on) return false;var def_control = new $.Deferred();def_control.done(function(){that.toggleControl(control,is_active)});var actions_last_index = Object.keys(data).length-1;var counter_actions = 0;for (var action in data) {var group=typeof(data[action])=='object'?data[action]:[data[action]];var keys_last_index = Object.keys(group).length-1;var counter_keys = 0;for (var key in group) {var def = (actions_last_index===counter_actions && keys_last_index===counter_keys)? def_control : null;var target = that.getTargets(group[key]);that.doAction(action, target, is_active, def);counter_keys ++;};counter_actions++;}})}};DropdownHandler = {names : {layer : 'js-dropdown',layer_multi : 'js-multi-dropdown',flag_init : 's-dropdown-is-init',flag_open : 's-dropdown-is-open',attr_id : 'data-dropdown-id',attr_suffix : 'data-dropdown-suffix',list : 'js-dropdown-list',flag_item_selected : 's-dropdown-item-selected',attr_item_val : 'data-dropdown-value',attr_item_alias : 'data-dropdown-headname',class_item_clear : 'js-dropdown-clear',header : 'js-dropdown-header',class_fixed_head : 's-dropdown-header-fixed',flag_head_active : 's-dropdown-head-is-active',attr_head_default : 'data-dropdown-header-default-name',attr_head_limit : 'data-dropdown-header-limit',attr_head_prefix : 'data-dropdown-header-prefix',attr_head_postfix : 'data-dropdown-header-postfix'},handler : {} ,opened_block : null,init_event_flag : false,open : function(block) {var self_open = this.opened_block && block.is(this.opened_block);this.close();if (self_open) return;block.addClass(this.names.flag_open);block.find('.'+this.names.list).show();block.find('.'+this.names.header).addClass(this.names.flag_head_active);this.opened_block = block;},close : function() {if (!this.opened_block) return;this.opened_block.removeClass(this.names.flag_open);this.opened_block.find('.'+this.names.list).hide();this.opened_block.find('.'+this.names.header).removeClass(this.names.flag_head_active);this.opened_block = null;},addCloseEvent: function() {if (this.init_event_flag) return;var that = this;$(document).on('mouseup.dropdown',function(e){if(!$(e.target).closest('.'+that.names.layer+',.'+that.names.layer_multi).length)that.close()});$(document).on('keydown.dropdown',function(e){if (e.keyCode===27) that.close()});$(window).on('scroll.dropdown',function(){that.close()});$(window).on('resize.dropdown',function(){that.close()});this.init_event_flag = true;},init : function() {var i_flag = this.names.flag_init;var that = this;$('.'+this.names.layer).not('.'+i_flag).find('.'+that.names.list).children('*').on('click',function(e){var t = $(this);var tag = t[0].nodeName;if(tag==='A'){var href=t.attr('href');if (href) {location.href = href;return true;}};var box=t.closest('.'+that.names.layer);var head=box.find('.'+that.names.header);var list=box.find('.'+that.names.list);var class_s = that.names.flag_item_selected;var selected=list.find('.'+class_s);selected.removeClass(class_s);t.addClass(class_s);if (!head.hasClass(that.names.class_fixed_head)) {var name = t.attr(that.names.attr_item_alias) || t.html();head.html(name)};that.close();e.preventDefault();e.stopPropagation()});$('.'+this.names.layer_multi).not('.'+i_flag).find('.'+that.names.list).children('*').on('click',function(e){var t = $(this);var box=t.closest('.'+that.names.layer_multi);var head=box.find('.'+that.names.header);var list=box.find('.'+that.names.list);var head_limit = parseInt( head.attr(that.names.attr_head_limit) || 99);var class_s = that.names.flag_item_selected;t.toggleClass(class_s);var clear_mode = t.hasClass(that.names.class_item_clear);var selected=list.find('.'+class_s);var titles=[], values = [];if (clear_mode) {selected.removeClass(class_s)} else {e.preventDefault();e.stopPropagation();selected.each(function() {var html = $(this).html();var title=$(this).attr('data-title')|| html;titles.push(title);var val=$(this).attr('data-dropdown')|| html;values.push(val)})};var title='';var overhead='';var len = titles.length;var name_prefix=head.attr(that.names.attr_head_prefix)|| '';var name_postfix=head.attr(that.names.attr_head_postfix)|| '';if (len && head_limit<=0) {overhead=' ('+(len-head_limit)+')';title = name_prefix + overhead;} else if (len) {var tmp = [];for (var i= 0;i<len;i++) {tmp.push(titles[i]);if (i===head_limit-1) {var n = len - head_limit;if(n>0)overhead=' и еще '+(len-head_limit);break;}};title=name_prefix+tmp.join(', ')+name_postfix+overhead;} else {title = head.attr(that.names.attr_head_default)};head.html(title);if (clear_mode) that.close()});$('.'+this.names.layer).add('.'+this.names.layer_multi).not('.'+i_flag).addClass(i_flag).each(function() {var block = $(this);var head=block.find('.'+that.names.header);var a = that.names.attr_head_default;if (!head.attr(a)) head.attr(a,head.html());head.on('click',function(){that.open(block)})});this.addCloseEvent()}};FormsHandler = {names : {main_class : 'js-form',logic_attr : 'data-form-logic',id_attr : 'data-form-id',suffix_attr : 'data-form-suffix',init_class : 's-form-init',cookie_form : 'form_params',submitbutton_class : 'js-form-submitbutton',extend_button_outside : 'js-extend-button-outside'},collection : [],form_preset : null,id_main : null,init : function() {var preset = MainLib.getJsonFromCookie(this.names.cookie_form,true);if (preset) this.form_preset = preset;var that = this;$('.'+this.names.main_class).not('.'+this.names.init_class).addClass(this.names.init_class).each(function(){var t = $(this);var logic = t.attr(that.names.logic_attr);var id = t.attr(that.names.id_attr);if (!id) {id = logic;t.attr('id',logic)};var suffix=t.attr(that.names.suffix_attr)|| '';that.collection[id + suffix] = new that.Form(that, t, id, logic, suffix)});$('.'+this.names.extend_button_outside).on('click',function(){var id = $(this).attr(that.names.id_attr);var form=$('form['+that.names.id_attr+'='+id+']');if (!form.length) return;var target_button=form.find('.'+FormsHandler.Form.prototype.names.ext_button_class);target_button.click()});if (window.InputAutoFormat) InputAutoFormat.init()},alertMsg : function(msg) {ModalHandler.alert(msg)},form2form : function(form, load_preset_flag) {var id = form.attr(this.names.id_attr);var suffix = form.attr(this.names.suffix_attr);if (!suffix) return;var source = this.collection[id];var target = this.collection[id + suffix];if (!source || !target) return;var data_preset = this.form_preset;var data_main = source.collectDataAll();var data;if (load_preset_flag && data_preset) {data = $.extend(true,{}, data_preset);target.data_basic = $.extend(true,{}, data_preset)} else {data = $.extend(true,{}, data_main);target.data_basic = $.extend(true,{}, data_main)};target.loadDataAll(data)},Form : function(parent,container,id, logic, suffix) {this.parent = parent;this.container = container;this.id = id;this.logic = logic;this.suffix = suffix;this.init()},getFormObjectForInnerElement : function(elem){var form=elem.closest('.'+this.names.main_class);var id = form.attr(this.names.id_attr);var form_obj = this.collection[id];form_obj.collectDataAll();return form_obj;}};FormsHandler.Form.prototype = {parent : null,container : null,id : null,suffix : null,data_basic : null,logic : null,submit_elems : null,ext_button: null,error_msg : null,data : {dropdown : null,depend : null,input : null,checkbox : null,radio : null},names : {depend_class : 'js-form-depend',depend_flag : DependHandler.names.active,depend_attr : DependHandler.names.attr_set,callback_name_attr : 'data-form-callback',enable_autoload_attr : 'data-enable-autoload',enable_submit_attr : 'data-form-submit',data_object_attr: AutocompleteHandler.names.attr_data,dropdown_class : 'js-form-dropdown',dropdown_multi_class:'js-form-multi-dropdown',dropdown_flag : DropdownHandler.names.flag_item_selected,dropdown_name_attr : DropdownHandler.names.attr_id,dropdown_value_attr : DropdownHandler.names.attr_item_val,dropdown_header : DropdownHandler.names.header,showclearbutton_class : 's-showclearbutton',clearbutton_class : 'js-input-clear',discharge_class : 'js-input-discharge-number',ext_button_class : 'js-extend-button',ext_button_active_class : 's-animate',ext_button_attr : 'data-extend-suffix',swap_button_class : 'js-swapbutton',input_name_attr : 'data-input-name',input_value_attr : 'data-input-value',input_title_attr : 'data-input-title',input_check_attr : 'data-input-check',input_clear_trigger : 'ClearInputValue'},loadDataAll: function(data) {data = data || this.parent.form_preset;if (!data || !data.id || data.id!==this.id) {return;};if (data.suffix && !this.suffix) {this.ext_button = this.container.find('.'+this.names.ext_button_class + '[' + this.names.ext_button_attr + '="' + data.suffix + '"]');this.ext_button.addClass(this.names.ext_button_active_class)};for (var section in data) {switch (section) {case 'depend' :var a = this.names.depend_flag;var blocks=this.container.find('.'+this.names.depend_class);blocks.removeClass(a);for (var i in data[section]) {var val = data[section][i];blocks.filter('['+this.names.depend_attr+'='+val+'-ext]').addClass(a)};break;case 'dropdown_multi':case 'dropdown':var blocks = this.container.find('.'+this.names.dropdown_class+',.'+this.names.dropdown_multi_class);for (var name in data[section]) {var val = data[section][name];var block=blocks.filter('['+this.names.dropdown_name_attr+'='+name+']');var items=block.find('li');items.removeClass(this.names.dropdown_flag);if(section==='dropdown'){var item_a=items.filter('['+this.names.dropdown_value_attr+'='+val+']');item_a.addClass(this.names.dropdown_flag);block.find('.'+this.names.dropdown_header).html(item_a.html())} else {var length = val.length;if (val.length<2) continue;for (var i=0; i<length-1; i++) {items.filter('['+this.names.dropdown_value_attr+'='+val[i]+']').addClass(this.names.dropdown_flag)};block.find('.'+this.names.dropdown_header).html(val[length-1])}};break;case 'input':for (var key in data[section]) {var val = data[section][key];var input = this.container.find('input['+this.names.input_name_attr+'='+key+']');if(typeof val=='object'){input.val(val.name || '');input.attr(this.names.data_object_attr, MainLib.json2str(val))} else {input.val(val)}};break;case 'checkbox':for (var key in data[section]) {var val = data[section][key];var input=this.container.find('input:checkbox['+this.names.input_name_attr+'='+key+']');if(val)input.attr('checked','checked');else input.removeAttr('checked')};break;case 'radio':for (var key in data[section]) {var val = data[section][key];var elems=this.container.find('input:radio[name='+key+']');elems.prop('checked',false);elems.filter('['+this.names.input_value_attr+'='+val+']').prop('checked',true)};break;}};this.data = data;},collectDataAll: function() {this.data = this.data_basic || {};this.data.id = this.id;this.data.suffix = this.suffix;var that = this;this.errors = [];this.container.find('input[type="text"], input[type="password"], input[type="tel"], input[type="hidden"]').each(function(){var t = $(this);if (!that.checkDepend(t)) return;var val = t.val();var msg = that.checkInput(t,val);if (msg) {that.errors.push(msg)};var key = t.attr(that.names.input_name_attr);if (!key) return true;var data = t.attr(that.names.data_object_attr);that.addData(key,data?MainLib.str2json(data): val,'input')});this.container.find('textarea').each(function(){var t = $(this);if (!that.checkDepend(t)) return;var val = t.val();var msg = that.checkInput(t,val);if (msg) {that.errors.push(msg)};var key = t.attr(that.names.input_name_attr);that.addData(key,val,'textarea')});this.container.find('input:checkbox').each(function(){var t = $(this);if (!that.checkDepend(t)) return;var key = t.attr(that.names.input_name_attr);var val=t.is(':checked')?1 : 0;that.addData(key,val,'checkbox')});this.container.find('input:radio:checked').each(function(){var t = $(this);if (!that.checkDepend(t)) return;var key=t.attr('name');if (!key) return;var val = t.attr(that.names.input_value_attr);if (!val) return;that.addData(key,val,'radio')});this.container.find('.'+this.names.dropdown_class).each(function(){var t = $(this);if (!that.checkDepend(t)) return;var elem=t.find('.'+that.names.dropdown_flag);if (!elem.length) return;var key = t.attr(that.names.dropdown_name_attr);var val = elem.attr(that.names.dropdown_value_attr);that.addData(key,val,'dropdown')});this.container.find('.'+this.names.dropdown_multi_class).each(function(){var t = $(this);if (!that.checkDepend(t)) return;var key = t.attr(that.names.dropdown_name_attr);var elem=t.find('.'+that.names.dropdown_flag);if (!elem.length) {that.addData(key,[-1],'dropdown_multi');return;};var values = [];elem.each(function(){var val = $(this).attr(that.names.dropdown_value_attr);values.push(val)});var hname=t.find('.'+that.names.dropdown_header).html();values.push(hname);that.addData(key,values,'dropdown_multi')});this.container.find('.'+this.names.depend_class).filter('.'+this.names.depend_flag).each(function(){var t = $(this);var val = t.attr(that.names.depend_attr);that.pushData(val,'depend')});return this.data;},addData : function (key,val,section) {this.data[section] = this.data[section] || {};this.data[section][key] = val;},pushData : function (val,section) {this.data[section] = this.data[section] || [];if (this.data[section].indexOf(val)===-1) this.data[section].push(val)},checkDepend : function(elem) {var a = this.names.depend_class;var b = this.names.depend_flag;var depend=elem.closest('.'+a);if (!depend.length) return true;if (!depend.hasClass(b)) return false;var depend2=depend.parents('.'+a);if (!depend2.length) return true;return depend2.hasClass(b)},checkInput : function(input,val) {var minlen = input.attr(this.names.input_check_attr);if (!minlen) return;val = MainLib.trim(val);var len = val.length;if (len>=minlen) return;var title=input.attr(this.names.input_title_attr)|| 'поле';var count = minlen+' значащ'+MainLib.word_ok(minlen,'ий','их','их')+' символ'+MainLib.word_ok(minlen,'','а','ов');var msg=(len?'Слишком короткий текст в ' : 'Отсутствует текст в ')+title;msg+=' (минимум '+count+')';return msg;},init : function() {var that = this;this.enable_autoload = this.container.attr(this.names.enable_autoload_attr);this.enable_submit = this.container.attr(this.names.enable_submit_attr);if (this.enable_submit) {var iframe_id=this.id+'-iframe';this.container.before('<iframe name="' +iframe_id+ '" style="display:none" src="about:blank"></iframe>');this.container.attr('target',iframe_id)};this.container.attr('action','javascript:void(0)');this.submit_elems=this.container.find('.'+this.parent.names.submitbutton_class);var ext_buttons=this.container.closest('.'+ModalHandler.names.modal).find('.'+ModalHandler.names.modal_buttons).find('.'+this.parent.names.submitbutton_class);if (ext_buttons.length) this.submit_elems = this.submit_elems.add(ext_buttons);this.submit_elems.on('click',function(){that.submit()});var inputs = this.container.find('input[type=text], input[type="tel"]');inputs.attr('autocomplete','off');inputs.each(function(){var t = $(this);t.val(t.val()|| '')});this.container.find('.input-wrapper').append('<i class="t-svg-cross-white '+this.names.clearbutton_class+'" title="очистить поле"></i>');var changer = function(input) {input.closest('.input-wrapper').toggleClass(that.names.showclearbutton_class,input.val().length>2)};inputs.on('keydown change',function(){changer($(this))});var discharge = function(input) {var val = input.val();if (!val) return;val=val.replace(/[^0-9]/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,' ');input.val(val)};var x = this.names.discharge_class;var inputs_discharge=inputs.filter('.'+x);inputs_discharge.on('keyup',function(){if (window[x]) clearTimeout(window[x]);var t = $(this);if (!t.val()) return;window[x] = setTimeout(function(){discharge(t)},700)});this.container.find('.'+this.names.clearbutton_class).on('click',function(){var input=$(this).prevAll('input');input.val('');input.attr(that.names.data_object_attr,'');input.change();input.trigger(that.names.input_clear_trigger);return false;});this.container.find('input').on('change.clear_form_preset',function(){that.parent.form_preset = null;if (that.ext_button) that.ext_button.removeClass(that.names.ext_button_active_class);$('input').off('.clear_form_preset')});this.container.find('.'+this.names.swap_button_class).on('click',function(){var a=$(this).prevAll('.input-wrapper');var b=$(this).nextAll('.input-wrapper');if(!a.length || !b.length)return eReport('swap_button - ошибка структуры 1');if (a.length>1 || b.length>1) {a=a.filter('.'+that.names.depend_flag);b=b.filter('.'+that.names.depend_flag)};a=a.find('input');b=b.find('input');if(!a.length || !b.length)return eReport('swap_button - ошибка структуры 2');var attr_name = that.names.data_object_attr;var attr_a=a.attr(attr_name)|| '';var attr_b=b.attr(attr_name)|| '';var val_a = a.val();var val_b = b.val();b.attr(attr_name, attr_a);a.attr(attr_name, attr_b);b.val(val_a);a.val(val_b);return true;});if (this.enable_autoload) this.loadDataAll();inputs_discharge.each(function(){discharge($(this))});inputs.each(function(){changer($(this))})},checkItem : function(item,logic,need_coord) {if(typeof item=='object'){if (!need_coord) return item;if (item.lat && item.lng) {item.coord = {lat:item.lat,lng:item.lng};return item;};if (!item.coord) item.coord = ProjectHandler.recognizeCoord(item.id,item.type);if(!item.coord)return eReport('ошибка определения координат',item);return item;};var result = ProjectHandler.recognizeItem(item,logic,need_coord);if (result) return result;var msg='Не удалось определить объект ['+item+']<br>';this.errors.push(msg);return false;},checkError:function() {if (!this.errors.length) return false;var msg=this.errors.join('<br>');this.parent.alertMsg(msg);this.errors = [];return true;},saveFormState2Cookie : function() {if (!this.enable_autoload) return;var h = MainSearchKitsHandler;if (!h) return;var kit_name = this.container.attr(h.names.attr);if (!kit_name) return;h.saveActiveKit(kit_name);MainLib.setJsonToCookie(this.parent.names.cookie_form, this.data, 3600)},reset : function() {this.container.find('textarea, input[type="text"], input[type="password"], input[type="tel"]').each(function(){$(this).val('')})},compactDataResult : function(basic_obj) {var result = $.extend(true,basic_obj || {},this.data.dropdown||{},this.data['dropdown_multi']||{},this.data.input || {},this.data.checkbox || {},this.data.radio || {});for(var i in result) {if(typeof(result[i])=='object' && !result[i].length|| !result[i]|| result[i]==='0'){delete(result[i])}};return result;},submit: function() {this.collectDataAll();if (this.checkError()) return;this.saveFormState2Cookie();switch(this.logic) {case 'search-realty' :var address=this.data.input['flat-custom-address'];if(address && typeof(address)==='object'){this.data.input['flat-custom-address']=address.name+'@'+address.type+'@'+address.id;};var params = this.compactDataResult();if (this.suffix) params.ext_form = 1;location.href = ProjectHandler.getRealtysearchUri(params);break;case 'search-job' :var params = this.compactDataResult();location.href = ProjectHandler.getJobsearchUri(params);break;case 'user-restore-password' :LoginHandler.submitRestorePassForm(this.data.input);break;case 'authorization' :LoginHandler.authorizationByForm(this.data);break;case 'cabinet-job':AjaxHandler.runScript('js_save_job',this.data,this);break;case 'cabinet-org':AjaxHandler.runScript('js_add_or_edit_company',this.data,this);break;case 'cabinet-rca':AjaxHandler.runScript('js_rca_company',this.data.input,this);break;case 'add-comment':var data=$.extend(true,{progress:'modal'},this.data);AjaxHandler.runScript('js_add_comments',data,this);break;case 'send-feedback-message':var data=$.extend(true,{progress:'modal'},this.data);AjaxHandler.runScript('js_feedback_message',data,this);break;case 'simple-search' :case 'simple-search-m' :var type=this.logic==='simple-search-m'?'super' : this.data.depend[0];var text=this.data.input['text-'+type];location.href = ProjectHandler.getSearchUri(text,type,true);break;case 'search-p2p' :case 'search-p2p-metro-single':var type=this.logic==='search-p2p-metro-single'?'p2p-metro' : this.data.depend[0];switch(type) {case 'p2p-all':var from=this.checkItem(this.data.input['p2p-all-a'],'p2p',true);var to=this.checkItem(this.data.input['p2p-all-b'],'p2p',true);if (this.checkError()) return;var data = {from:from,to:to};var params = this.data.checkbox || {};location.href = ProjectHandler.getP2PUri(data,params);break;case 'p2p-rail':var from=this.checkItem(this.data.input['p2p-rail-a'],'plat2plat');var to=this.checkItem(this.data.input['p2p-rail-b'],'plat2plat');if (this.checkError()) return;var result = ProjectHandler.getPlat2PlatUri(from,to);if (result) location.href = result;else {this.parent.alertMsg('Нет расписания между этими станциями')};break;case 'p2p-metro':var item1=this.checkItem(this.data.input['p2p-metro-a'],'single_metro');var item2=this.checkItem(this.data.input['p2p-metro-b'],'single_metro');if (this.checkError()) return;location.href = ProjectHandler.getMetro2MetroUri(item1.id,item2.id);break;};break;case 'custom_function' :var func_name = this.container.attr(this.names.callback_name_attr);var func=new Function('a','b',func_name.replace('()','(a,b)'));func.call(null,this.data,this);break;case 'return':return $.extend(true,{},this.data);default:console.log(this.data);console.log('logic: bad case',this.logic)};if (this.enable_submit) this.container[0].submit()}};MainMenuHandler = {status : false,classes : {hamburger : 'js-toggle-mainmenu',box : 'b-vd-header-mainmenu',global_wrapper : 'b-global-wrapper'},init : function() {this.createmenu();this.menu_block=$('.'+this.classes.box);this.button=$('.'+this.classes.hamburger);var that = this;this.global_wrapper=$('.'+this.classes.global_wrapper);this.button.on('click',function(e){e.stopPropagation();if (that.status) that.hidemenu();else that.showmenu()});this.menu_block.on('click',function(e){e.stopPropagation()});this.menu_block.find('.cross').add($('body')).on('click',function(){that.hidemenu()});this.menu_block.find('a').on('click',function(e){e.stopPropagation();that.hidemenu()});$(window).on('scroll',function(){that.hidemenu()})},hidemenu : function(){if (!this.status) return;this.menu_block.hide();this.button.removeClass('active');this.status = false;this.global_wrapper.removeClass('s-mainmenu-visible')},showmenu :function(){if (this.status) return;this.menu_block.slideDown('fast','linear');this.button.addClass('active');this.status = true;this.global_wrapper.addClass('s-mainmenu-visible')},last_hash : null,createmenu : function(){var target=$('.b-vd-header-mainmenu-content .column1');var text='';$('.b-vd-footer-content nav').not('.main-section').each(function(){text+='<nav>'+$(this).html()+'</nav>';});target.html(text);var target=$('.b-vd-header-mainmenu-content .column2');var text=$('.b-vd-footer-content .main-section').html();target.html(text + '<div class="cross t-svg-cross-white" title="Закрыть меню"></div>');var links=target.find('.sublist a');var that = this;setInterval(function(){var hash=document.location.hash.replace('#','');if (that.last_hash === hash) return;var uri = document.location.pathname + document.location.hash;links.each(function(){var t = $(this);if(t.attr('href')===uri){links.removeClass('active');t.addClass('active');that.last_hash = hash;return false;}})},1500)}};MainSearchDisplayHandler = {names : {main_layer : 'b-vd-mainsearch',compact_mode_layers_selector : '.b-vd-mainsearch-header, .b-vd-mainsearch-tabs-wrapper',class_off : 's-mainsearch-off',button: 'js-toggle-mainsearch',button_active : 's-mainsearch-active',preset_varname : 'mainsearch_status',preset_mode : 'mainsearch_compact_mode',trigger_hide : 'MainsearchHide',trigger_show : 'MainsearchShow'},status : false,showEffect : function(){if(!this.compact_mode)return this.container.slideDown('medium','linear').promise();return $.when(this.container.animate({paddingBottom: 44,paddingTop: 34},'fast','linear'),this.blocks4compactmode.slideDown('medium','linear'))},hideEffect : function(){if(!this.compact_mode)return this.container.slideUp('fast','linear').promise();return $.when(this.blocks4compactmode.slideUp('fast','linear'),this.container.animate({paddingBottom: 3,paddingTop: 3},100,'linear'))},blinkEffect : function(){var block = this.container;block.animate({opacity:1,opacity:0.5},100,'linear',function(){block.animate({opacity:0.5,opacity: 1},100,'linear')})},show : function(){if (this.status) return;this.status = true;this.buttons.addClass(this.names.button_active);var that = this;this.showEffect().done(function(){that.container.removeClass(that.names.class_off);$(window).trigger(that.names.trigger_show)})},hide : function(){if (!this.status) return;this.status = false;this.buttons.removeClass(this.names.button_active);var that = this;this.hideEffect().done(function(){that.container.addClass(that.names.class_off);$(window).trigger(that.names.trigger_hide)})},blink : function(){this.blinkEffect()},init : function(){this.container=$('.'+this.names.main_layer);this.blocks4compactmode = $(this.names.compact_mode_layers_selector);this.compact_mode = MainLib.getJsConfig(this.names.preset_mode) || false;if (MainLib.getJsConfig(this.names.preset_varname)) {this.status = true;};this.buttons=$('.'+this.names.button);if (!this.container.hasClass(this.names.class_off)) {this.buttons.addClass(this.names.button_active);this.status = true;};var that = this;this.buttons.on('click',function(){if (that.status) that.hide();else that.show()})}};MainSearchKitsHandler = {collection : [],active_kit_name : null,names : {main : 'b-vd-mainsearch',modal: 'b-vd-mainsearch-modal',cookie_kit : 'kit_params',attr : 'data-kit'},loadActiveKit : function(){var preset_kit_name = MainLib.getCookie(this.names.cookie_kit);if (preset_kit_name) this.active_kit_name = preset_kit_name;},saveActiveKit : function(val){MainLib.setCookie(this.names.cookie_kit,val,{'max-age': 3600*24})},init : function(superset_name) {superset_name=superset_name || 'main';var container=$('.'+this.names[superset_name]);this.collection[superset_name] = new this.Kit(this,container)},Kit : function(parent,container){this.parent = parent;this.container = container;this.init()}};MainSearchKitsHandler.Kit.prototype = {parent : null,container : null,names : {tab : 'js-mainsearch-tab',kit : 'js-mainsearch-kit',kit_active : 's-kit-active',tab_active : 's-tab-active'},tabs : null,kits : null,filterByAttr : function(val) {return '['+this.parent.names.attr+'='+val+']'},saveActiveName : function(val) {this.parent.active_kit_name = val;},loadActiveName : function() {return this.parent.active_kit_name;},setActive : function(val) {this.setActiveKit(val);this.setActiveTab(val)},setActiveKit : function(val) {var a = this.names.kit_active;this.kits.removeClass(a);var target_kit = this.kits.filter(this.filterByAttr(val));target_kit.addClass(a);this.saveActiveName(val)},setActiveTab : function(val) {val = val || this.loadActiveName();var a = this.names.tab_active;this.tabs.removeClass(a);var target_tab = this.tabs.filter(this.filterByAttr(val));target_tab.addClass(a)},init : function() {this.kits=this.container.find('.'+this.names.kit);this.tabs=this.container.find('.'+this.names.tab);var active_kit=this.kits.filter('.'+this.names.kit_active);if (!active_kit.length) active_kit = this.kits.eq(0);var kit_active_name = active_kit.attr(this.parent.names.attr);var preset_active_name = this.loadActiveName();if (preset_active_name && preset_active_name != kit_active_name) this.setActiveKit(preset_active_name);else this.setActiveKit(kit_active_name);this.setActiveTab();var that = this;$('.'+this.names.tab).on('click',function(){var active_name = $(this).attr(that.parent.names.attr);that.setActiveTab(active_name);that.setActiveKit(active_name)})}};ModalHandler = {names : {container:'b-modal-overlay',modal : 'js-modal',container_active : 's-overlay-active',modal_active : 's-modal-active',close_elems : 'js-modal-close',modal_alert : 'modal_alert',modal_buttons : 'modal-buttons',wrapper_class : 't-modal-wrapper'},init_status : false,container : null,active_block : null,blocks_stack : [],handleEntryForm : function(new_flag) {if (!window.FormsHandler) return false;var form=this.active_block.find('.'+FormsHandler.names.main_class);if (!form.length) return false;FormsHandler.form2form(form, new_flag);return true;},close : function() {if (!this.active_block) return;this.blocks_stack = this.blocks_stack.slice(0,-1);this.active_block.removeClass(this.names.modal_active);var count = this.blocks_stack.length;if (!count) {this.container.removeClass(this.names.container_active);this.active_block = null;} else {this.active_block = this.blocks_stack[count-1];}$(document).trigger('modalclose')},button : function(button, block){var mb = this.names.modal_buttons;var bb=block.find('.'+mb);if (!bb.length) {block.children('div').append('<div class="' +mb + '"></div>');bb=block.find('.'+mb)};bb.append('<button'+ (button.classes ? ' class="' + button.classes + '"' : '')+'>'+button.text+'</button>');var b=bb.find('button').eq(-1);if(button.action)b.on('click',button.action);return b;},render : function(params) {this.container.append('<div '+ (params.z_index ? ' style="z-index:'+ params.z_index +'"' : '')+' class="' + this.names.wrapper_class + ' ' + this.names.modal + '">'+ '<div class="t-modal ' + (params.classes || '') +'"'+ (params.style ? ' style="' + params.style +'" ': '')+'>'+ '<div class="modal-header" >' + (params.header || '') + '</div>'+ '<div class="modal-cross ' + this.names.close_elems +'"></div>'+params.body+'</div>'+'</div>');var block=this.container.children('div').eq(-1);if (params.buttons)for (var i in params.buttons)this.button(params.buttons[i], block);if (window.ProjectHandler) ProjectHandler.initHandlersUI();return block;},open : function(params) {this.init();var exists_flag = params instanceof jQuery;var block = exists_flag ? params : this.render(params);block.addClass(this.names.modal_active);this.container.addClass(this.names.container_active);this.blocks_stack.push(block);this.active_block = block;this.handleEntryForm(!exists_flag);return block;},alert : function(msg, header,classes) {var params = {header : header || 'уведомление системы',body : '<div class="modal-content">' + msg + '</div>',classes : this.names.modal_alert+(classes?' '+classes : '')};return this.open(params)},loader : function(xhr, header) {var that = this;var params = {header : header || 'ожидается загрузка',body : ProjectHandler.loader_html,classes : this.names.modal_alert,buttons : [{text : 'Прервать',action : function(){ that.close(); xhr && xhr.abort()}}]};return this.open(params)},init : function() {if (this.init_status) return;this.init_status = true;$('body').append('<div class="' + this.names.container + '"></div>');this.container=$('.'+this.names.container);var that = this;$(document).on('mouseup.modal',function(e){var a = that.active_block;if (!a) return;var div=a.children('div');if (!a.is(div.target) && !div.has(e.target).length) {that.close()}});$(document).on('keydown.modal',function(e){if (!that.active_block) return;if (e.keyCode===27) that.close()});this.container.on('click.modal','.'+that.names.close_elems,function(e){e.stopPropagation();that.close()})}};AjaxHandler = {names : {main_class : 'js-ajax-script',init_class : 's-ajax-init',script_attr : 'data-ajax-script',onclick_attr : 'data-onclick',postponed_attr : 'data-ajax-postponed',data_attr : 'data-ajax-preset'},postponed_defs : {},last : {name : null,xhr : null,item : null,data : null},defPostponed : function(elem) {var postponed = elem.attr(this.names.postponed_attr);if (!postponed) {var def = new $.Deferred() ;def.resolve();return def;};var def = this.postponed_defs[postponed];if (!def) {var postponed_src=MainLib.getJsConfig('postponed',postponed);if(!postponed_src)eReport('postponed not exists',postponed);if(!postponed_src['css']&& !postponed_src['js'])postponed_src=MainLib.reformatSrcSet(postponed_src);def = MainLib.importSrcGroup4(postponed_src);this.postponed_defs[postponed] = def;};return def;},runOnclick : function(onclick,data,elem) {var func=new Function('a','b',onclick.replace('()','(a,b)'));func.call(null,data,elem)},runScript : function(src_name,data,elem) {data = data || {};data.modal_name='modal|'+(src_name+(data.type || '')+(data.key || '')).hashCode();data.modal_obj=MainLib.getJsConfig('data-ajax',data.modal_name);var src=MainLib.getJsConfig('data-ajax',src_name);if(!src)return eReport('not exists in jsconfig[data-ajax]',src_name);if (this.last.xhr) this.last.xhr.abort();var params = {url: src,dataType: 'script',cache: true,async : true,error: function(xhr,msg){if(msg!=='abort')eReport(msg)}};var loader_flag=!data.modal_obj && data.progress==='modal';if (loader_flag) {params.beforeSend = function(xhr){ ModalHandler.loader(xhr)};};this.last = { name : src_name, item : elem, data : data };this.last.xhr = $.ajax(params);if (loader_flag) this.last.xhr.done(function(){ModalHandler.close()})},init : function(){var that = this;$('.'+this.names.main_class).not('.'+this.names.init_class).filter('[onclick]').each(function(){var t = $(this);var action=t.attr('onclick');t.removeAttr('onclick');t.attr(that.names.onclick_attr,action)});$('.'+this.names.main_class).not('.'+this.names.init_class).addClass(this.names.init_class).on('click',function(e){e.stopPropagation();var t = $(this);var src_name = t.attr(that.names.script_attr);var onclick = t.attr(that.names.onclick_attr);if (src_name && onclick) {return eReport('do not use both - script and onclick - attributes')} else if (!src_name && !onclick) {return eReport('not exists script or onclick attributes')};var data_str = t.attr(that.names.data_attr);var data = data_str ? JSON.parse(data_str.replace(/'/g,'"')) : {};if(data['close_prev_modal'])ModalHandler.close();that.defPostponed(t).then(function(){if (onclick) {that.runOnclick(onclick,data,t)} else {that.runScript(src_name,data,t)}},function(){console.log('ошибка загрузки postponed_attr')})})}};ProjectHandler = {initHandlersUI : function() {if (window.DropdownHandler) DropdownHandler.init();else console.info('DropdownHandler not load');if (window.DependHandler) DependHandler.init();else console.info('DependHandler not load');if (window.AutocompleteHandler) AutocompleteHandler.init();else console.info('AutocompleteHandler not load');if (window.FormsHandler) FormsHandler.init();else console.info('FormsHandler not load');if (window.AjaxHandler) AjaxHandler.init();else console.info('AjaxHandler not load');if (window.ActionHandler) ActionHandler.init();else console.info('ActionHandler not load')},loader_html :'<p class="t-load-animation"><b><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i></b></p>',getSearchUri : function(text, logic, encode) {if(typeof text=='object')return text.url;text=text.replace('&',' ');var uri='/search?str='+text+(logic?'&logic='+logic : '');return encode ? encodeURI(uri) : uri;},getRealtysearchUri : function(params) {return '/realty?option='+JSON.stringify(params)},getSrc4RealtyClusters : function(options) {var href='/services/onmap-realty-data?options=';if (options) return href + options;var str = location.search;if(!str)return href+JSON.stringify({"flat-action-type":"rent","flat-type":"1","flat-area":"1"});if (str.match(/\%/)) str = decodeURIComponent(str);var m = /option=(\{[^\}]*\})/.exec(str);return href + m[1];},getJobsearchUri : function(params) {return '/rabota/?option='+JSON.stringify(params)},getP2PUri: function(data,params) {var getstr='';for (var direct in data) {var d = data[direct];var getparams = [d.type || 'coord',d['coord'].lat,d['coord'].lng,d.name?MainLib.stripTags(d.name): '',d.url || '',d.id || 0];getstr+=(getstr?'&' : '?')+direct+'='+JSON.stringify(getparams)};getstr+='&option='+JSON.stringify(params);return '/search-route'+encodeURI(getstr)},getMetro2MetroUri: function(from_id,to_id) {return '/metro.html#'+'m'+from_id+'m'+to_id;},getPlat2PlatUri: function(from,to) {var data = {id_from : from.id,url_from : from.url,id_to : to.id,url_to : to.url};var url='/services/search-plat2plat';var result = null;$.ajax({type: 'GET',url: url,dataType: 'json',cache: true,async: false,data: data,success: function (resp) { result = resp.href || 0; },error: function(xhr,msg){eReport(msg)}});return result;},recognizeItem : function(text, logic, need_coord) {text=text.replace(/\[[^\]]+\]/,'');var url='/services/search-once?str='+text+(logic?'&logic='+logic : '')+(need_coord?'&coord=1': '');var result = null;$.ajax({url: url,dataType: 'json',cache: true,async : false,success: function(resp){ result = resp;},error: function(xhr,msg){eReport(msg)}});if (!result) return false;if (need_coord && !result.coord) return false;return result;},recognizeCoord : function(id, type) {var url='/services/search-coord?id='+id+'&type='+type;var result = null;$.ajax({url: url,dataType: 'json',cache: true,async : false,success: function(resp){ result = resp;},error: function(xhr,msg){eReport(msg)}});return result;},createAuthorizeDialog : function(text_before, text_after) {var a = AjaxHandler;var content=(text_before || '')+ '<span class="as-link red ' + a.names.main_class + '" '+ 'onclick="LoginHandler.createDialogByPreset()" '+ a.names.postponed_attr + '="src4modal_login" '+ a.names.data_attr + '="{\'type\':\'login\',\'progress\':\'modal\',\'close_prev_modal\':\'1\'}"'+'>Войдите</span>'+' на сайт или '+ '<span class="as-link red ' + a.names.main_class + '" '+ 'onclick="LoginHandler.createDialogByPreset()" '+ a.names.postponed_attr + '="src4modal_login" '+ a.names.data_attr + '="{\'type\':\'registration\',\'progress\':\'modal\',\'close_prev_modal\':\'1\'}"'+'>зарегистрируйтеcь</span>'+(text_after || '.');ModalHandler.alert(content,'Необходима авторизация');a.init()},saveUserData : function(data) {MainLib.setJsConfig({user_id:data.user_id,hash:data.hash},'user-login-data')},loadUserData : function() {return MainLib.getJsConfig('user-login-data')},isMobile : function(){var device=MainLib.getJsonFromCookie('device');if (!device) return false;return !!(device['mobile']|| device['forced'])},swapLoginLinkState : function() {if (this.isMobile()) {var elem=$('.b-menu-login-button').closest('li');elem.after('<li><a href="/cabinet/">Личный кабинет</a></li>')} else {var elem=$('.js-login-cabinet-link');elem.after('<a class="link" data-action-icon="login" href="/cabinet/">Личный кабинет</a>')};elem.remove()},checkAuthorizationForUser : function() {var def = new $.Deferred();var user_data = this.loadUserData();if (user_data) {def.resolve();return def;};var c_name='moscowmap-user';var user_cookie = MainLib.getJsonFromCookie(c_name);if (user_cookie) {var that= this;$.ajax({type: 'POST',url: '/remotes/user-autologin',dataType: 'json',data: user_cookie}).then(function(resp) {if (resp.success) {def.resolve();that.saveUserData(resp)} else {def.reject();MainLib.deleteCookie(c_name)}},function(resp) {def.reject();console.log(resp)});return def;} else {def.reject()};return def;},alertIfSmallViewport : function() {var device=MainLib.getJsonFromCookie('device');if(!device || device['mobile']|| device['forced']|| device.mobile_alert_disable)return;var view = {width : $(window).outerWidth(),height : $(window).outerHeight()};view.landscape = view.width > view.height;if (view.landscape && view.width<900 || view.width<500) {var params = {header : 'Сообщение системы',body : '<div class="modal-content">Если вы зашли с телефона или планшета, можно переключится на&nbsp;'+'<span class="as-link red" onclick="MainLib.toMobile()">Мобильную версию</span> сайта.<br><br>'+'Ссылка на мобильную версию также доступна в главном меню. '+'Из&nbsp;мобильной версии аналогично, через меню можно перейти в&nbsp;версию для компьютеров.'+'</div>',classes: 'modal_mobile_alert',buttons : [{text:'Мобильная версия',action: function() { MainLib.toMobile()},classes: ' red-button'},{text:'Отмена',action: function(){device.mobile_alert_disable = 1;MainLib.setJsonToCookie('device',device,3600 *24 *100);ModalHandler.close()}}]};ModalHandler.open(params)}},init : function() {this.alertIfSmallViewport();this.initUser();this.initElementsUI()},initUser : function(){var that = this;this.checkAuthorizationForUser().done(function(){that.swapLoginLinkState()})},initElementsUI : function() {var that = this;var toHref = function(a_elem){if (!a_elem.length) return;var href=a_elem.attr('href');if (!href) return;location.href = href;};$('.js-cards-box').on('click','.org a.address, .item a.address ',function(e){var href=$(this).attr('href');if (!href) return;e.preventDefault();e.stopPropagation();location.href = href;}).on('click','.org, .item',function(){toHref($(this).find('.name'))});$('.js-houses-box .link-basic').on('click',function(e){toHref($(this).closest('.house').find('a.house-name'))});$('.js-flat-cards .t-flat').on('click',function(e){location.href=$(this).attr('data-href')});$('.js-itemlinks-box .item').on('click',function(){toHref($(this).find('a'))});$('.js-addorg-button').on('click',function(){that.checkAuthorizationForUser().then(function(){location.href='/cabinet/new-company';},function(){that.createAuthorizeDialog('Добавлять организации могут только авторизованые пользователи. ')})});$('.js-addvacancy-button').on('click',function(){that.checkAuthorizationForUser().then(function(){location.href='/cabinet/new-vacancy';},function(){that.createAuthorizeDialog('Добавлять вакансии могут только авторизованые пользователи. ')})});$('.js-alpha-list .alpha-group a').on('click',function(){var href=$(this).attr('href');if (href) location.href = href;});$('.js-alpha-list').each(function(){var all_titled=$(this).find('.alpha-title');all_titled.each(function() {var t = $(this);var dep_group=t.next('.alpha-group').eq(0);if(!dep_group.length)return eReport('incorrect DOM (.alpha-title + .alpha-group)');t.on('click',function(){if(t.hasClass('direct')){var a=dep_group.children('*');if (a.length) a.click();else return eReport('incorrect DOM (.alpha-group > ? )')} else {if(t.hasClass('active')){t.removeClass('active')} else {all_titled.removeClass('active');t.addClass('active')}}})})})}};ActionHandler = {names : {action_class : 'js-onclick-action',action_init_class : 's-onclick-action-init',action_type_attr : 'data-action-type',action_data_attr : 'data-action-data'},showP2PFormWithData : function(data) {window.scrollTo(0,0);var handler = MainSearchDisplayHandler;if (!handler.status) handler.show();else handler.blink();MainSearchKitsHandler.collection['main'].setActive('p2p');var attr_name = FormsHandler.Form.prototype.names.input_name_attr;var attr_data = FormsHandler.Form.prototype.names.data_object_attr;var input=FormsHandler.collection['mainsearch-p2p'].container.find('input').filter('['+attr_name+'='+data.key+']');data.name=MainLib.stripTags(data.name).replace(/\+/g,' ');input.val(data.name);input.attr(attr_data,MainLib.json2str(data));input.change()},showMainSearch : function(kit) {window.scrollTo(0,0);MainSearchDisplayHandler.show();MainSearchKitsHandler.collection['main'].setActive(kit)},doAction : function(type, data) {switch(type) {case 'jump2form' :this.showMainSearch(data.kit || data);if (data.dropdown) {$('.'+DropdownHandler.names.layer+'[data-dropdown-id='+data.dropdown.id+']').find('li[data-dropdown-value='+data.dropdown.value+']').click()};if (data.focus) {var form = FormsHandler.collection[data.focus.form];form.container.find('input[data-input-name="'+data.focus.input+'"]').click().focus()};break;case 'p2p' :this.showP2PFormWithData(data);break;default:eReport('action type : bad case',type)}},init : function () {var that = this;$('.'+this.names.action_class).not('.'+this.names.action_init_class).addClass(this.names.action_init_class).on('click',function(e){e.preventDefault();var t = $(this);var type = t.attr(that.names.action_type_attr);var data = t.attr(that.names.action_data_attr);if (data) {if(data.indexOf('%')!==-1)data=MainLib.str2json(data);else if (data.indexOf("'")!==-1) data = JSON.parse( data.replace( /'/g, '"'))};that.doAction(type,data)})}};AsideBobberHandler = {aside_class : 't-content-2column-aside',main_class : 'b-aside-bobber',basic_top : 10,offset_pagemenu : 0,min_diff : 100,is_fixed : false,unfixBobber: function() {this.bobber.css({position : '',top : ''});this.is_fixed = false;},fixBobber : function(offset) {offset = offset || 0;var result_top = offset+ this.basic_top+ this.offset_pagemenu;this.bobber.css({position : 'fixed',top : result_top+'px'});this.is_fixed = true;},calc : function() {this.offset_pagemenu = PageMenuBobberHandler.is_fixed? PageMenuBobberHandler.bobber_size.height + PageMenuBobberHandler.top_margin: 0;var box_height = this.box.height() ;var snap_top = MainLib.getScrollTop(this.snap,true) ;var box_top = MainLib.getScrollTop(this.box,true);var current_diff = snap_top - box_top;if (this.is_fixed) {if (window.pageYOffset < snap_top - this.offset_pagemenu) {this.unfixBobber()} else {var offset = box_height- current_diff- this.bobber_height+ MainLib.getScrollTop(this.snap,false)- this.offset_pagemenu;this.fixBobber(offset<0 ? offset : 0)}} else {if (box_height > this.bobber_height + this.min_diff + current_diff) {var top = MainLib.getScrollTop(this.bobber, false);var control_top = this.basic_top + this.offset_pagemenu;if (top < control_top) this.fixBobber()}}},addEvents : function() {var that = this;$(window).on('resize',function(){that.calc()}).on('scroll',function(){that.calc()});this.calc()},bobberHeight : function(){this.bobber_height = this.bobber.height();return this.bobber_height;},init : function() {this.bobber=$('.'+this.main_class);if (!this.bobber.length) return false;this.bobber.before('<div></div>');this.snap=this.bobber.prev('div');this.box=this.bobber.closest('.'+this.aside_class);var that = this;if (this.bobberHeight()) this.addEvents();else this.timer = setInterval(function(){if (that.bobberHeight()) {clearInterval(that.timer);that.addEvents()}},1500)}};PageMenuBobberHandler = {aside_class : 't-content-2column',main_class : 'b-pagemenu-bobber',basic_top : 0,is_fixed : false,top_margin : 20,unfixBobber: function() {this.bobber.css({position : '',top : ''});this.is_fixed = false;this.snap.css({'height':'','margin-top' :'','margin-bottom':''})},fixBobber : function(top) {this.bobber.css({position : 'fixed',top :(top||0)+this.basic_top+'px'});this.is_fixed = true;this.snap.css({'height' : this.bobber_size.height+'px','margin-top' : this.bobber_size.m_top,'margin-bottom' : this.bobber_size.m_bottom})},calc : function() {if (this.is_fixed) {var snap_top = MainLib.getScrollTop(this.snap,true);if (window.pageYOffset < snap_top) {this.unfixBobber()} else {var box_height = this.box.height()-309;var offset = box_height - this.bobber_size.height + MainLib.getScrollTop(this.snap,false);this.fixBobber(offset<0 ? offset : 0)}} else {var top = MainLib.getScrollTop(this.bobber, false);if (top < this.basic_top) this.fixBobber()}},addEvents : function() {var that = this;$(window).on('resize',function(){that.calc()}).on('scroll',function(){that.calc()});this.calc()},init : function() {this.bobber=$('.'+this.main_class);if (!this.bobber.length) return false;this.bobber_size = {height : this.bobber.height(),m_top : this.bobber.css('margin-top'),m_bottom : this.bobber.css('margin-bottom')};this.bobber.before('<div></div>');this.snap=this.bobber.prev('div');this.box=this.bobber.next('.'+this.aside_class);this.addEvents()}};PagemenuHandler = {names : {main_layer_class : 'b-pagemenu',anchor_class : 'js-pagemenu-anchor',item_active : 's-anchor-active',direct_link_class : 's-direct-link',content_class : 'b-vd-content',item_2top_class : 'js-hide-on-top',item_2top_hidden : 's-item2top-hidden'},offset : 10,active_item_key : null,doScroll : function(top,hash) {location.hash = hash;$(window).scrollTop(top)},markActiveItem : function(key) {var a = this.names.item_active;if (this.active_item_key) this.items_set[this.active_item_key].removeClass(a);if (!this.items_set[key]) {this.active_item_key = null;} else {if (key) this.items_set[key].addClass(a);this.active_item_key = key;}},addEvents : function() {var that = this;this.menu_items.on('click',function(e){e.preventDefault();var t = $(this);if (t.hasClass(that.names.direct_link_class)) {location.href=t.attr('href');return true;};var key=t.attr('href').replace('#','');if (key=='') {that.doScroll(0,'');return;};if (!that.anchors_set[key]) return;that.doScroll(that.anchors_set[key].top + that.offset,key);$(window).resize()});$('a[href^="#"]').not('[class^="to-"]' ).on('click',function(e){e.preventDefault();var key=$(this).attr('href').replace('#','');if (!that.anchors_set[key]) return;that.doScroll(that.anchors_set[key].top + that.offset,key)});$(window).on('scroll',function(){var page_top = window.pageYOffset;that.menu_item2top.toggleClass(that.names.item_2top_hidden, page_top<300);var content_height = that.content_layer.height();if (content_height!=that.content_height) {that.content_height = content_height;that.calcAnchorPositions()};for(var key in that.anchors_set) {var anchor = that.anchors_set[key];if (anchor.from>page_top || anchor.to<page_top) continue;that.markActiveItem(key);var ok_flag = true;break;};if (!ok_flag) that.markActiveItem(null)})},calcAnchorPositions : function() {if (!this.page_anchors.length) return false;this.anchors_set = {};var that = this;this.items_set = {};this.menu_items.each(function(){var key=$(this).attr('href').replace('#','');that.items_set[key] = $(this)});this.page_anchors.each(function(){var t = $(this);var key=t.attr('id');if(key=='')return true;var top = MainLib.getScrollTop(t,true);that.anchors_set[key] = {top : top,from : top - 90};});var prev_key = null;for (var key in this.anchors_set) {if (!prev_key) {prev_key = key;continue;};this.anchors_set[prev_key].to = this.anchors_set[key].top - 100;prev_key = key;};this.anchors_set[prev_key].to=MainLib.getScrollTop($('.b-vd-footer'),true)-200;},checkPageHash : function() {var key=location.hash.replace('#','');if (key) {this.items_set[key] && this.items_set[key].click()}},init : function() {this.menu_items=$('.'+this.names.main_layer_class).find('a');this.page_anchors=$('.'+this.names.anchor_class);if (!this.menu_items.length || !this.page_anchors.length) return false;this.menu_item2top=this.menu_items.filter('.'+this.names.item_2top_class);this.content_layer=$('.'+this.names.content_class);this.content_height = this.content_layer.height();var h = PageMenuBobberHandler;this.offset += - h.bobber_size.height - h.top_margin;this.calcAnchorPositions();this.addEvents();this.checkPageHash()}};MapsHandler = {maps : {}, defset : {},names : {bigmap_buttons_class : 'js-toggle-bigmap',bigmap_buttons_active_class : 's-toggle-bigmap-active',bigmap_buttons_init_class : 's-toggle-bigmap-init'},src_sets : {map:'src4map2019',clusters:'src4mapclusters2019'},map_settings_by_type : {'main' :{ruler : true,expand_to: 'fullscreen',selector :'.b-mainmap',use_start_data : true},'fullscreen' :{ruler : true,collapse_to:'main',selector : '.b-fullscreen-map',use_start_data : true},'fullscreen-only' :{ruler : true,selector : '.b-fullscreen-map',use_start_data : false},'modal-select-point':{},'modal-select-address':{use_start_data : true},'modal-select-house-or-street' :{}},map_common_preset : {siteurl : MainLib.getJsConfig('site_url')|| 'https://www.moscowmap.ru/',mapurl : 'https://www.moscowmap.ru/leaflet/',lat : 55.75,lng : 37.62,zoom : 10},Map : function(handler, container, map_type, map_key) {this.handler = handler;this.container = container;this.type = map_type;this.key = map_key;this.preset = $.extend(true,{},handler.map_common_preset);this.settings = $.extend(true,{},handler.map_settings_by_type[map_type]);this.init()},loadSources : function(type,callback) {var key_flag='flag-loader-'+type;if (this[key_flag]) {callback && callback();var def = new $.Deferred();def.resolve();return def;};this[key_flag] = true;var src_set=MainLib.getJsConfig('postponed',this.src_sets[type]);var def = MainLib.importSrcGroup4(src_set);def.done(callback);def.fail(function(){console.log('fail',type)});return def;},loadMapStartData : function() {var data=MainLib.getJsConfig('map_start_data');if (!data) return;if(data['clusters_mode']==='realty'){data.src = ProjectHandler.getSrc4RealtyClusters(data.options)};this.map_common_preset.start_data = data;this.use_clusters_flag=(data.type==='clusters');this.use_ajaxsrc_flag=(data['src_type']==='ajax')},preloadAjaxData: function() {var data = this.map_common_preset.start_data;var def = new $.Deferred();if(data['src_type']!=='ajax'){def.resolve();return def;};var ajax = MainLib.importJSON(data.src);ajax.then(function(resp){data.json = resp;delete data['src_type'];delete data['src'];def.resolve()}, function(){console.log('fail: '+this.url);def.reject()});return def;},preloadClustersData : function() {var data = this.map_common_preset.start_data;var def = new $.Deferred();if(data['src_type']==='ajax'){def = this.preloadAjaxData()} else if (data.json) {def.resolve()};return def;},createMap : function(map_type, selector) {var settings = this.map_settings_by_type[map_type];if(!settings)eReport('createMap: undefined map_type',map_type);var map_key=map_type+(selector || '');selector = selector || settings.selector;var elem = $(selector);if(!elem.length)eReport('createMap: bad map selector',selector);if (settings.use_start_data) this.loadMapStartData();if (!this.maps[map_key]) {elem.addClass('s-map-loaded t-map-container').html(ProjectHandler.loader_html);this.defset[map_key] = new $.Deferred();var that = this;var callback = function(){that.maps[map_key] = new that.Map(that, elem, map_type, map_key)};if (this.use_clusters_flag) {this.loadSources('map').done(function(){that.preloadClustersData().done(function(){that.loadSources('clusters').done(callback)})})} else if (this.use_ajaxsrc_flag) {this.loadSources('map').done(function(){that.preloadAjaxData().done(callback)})} else {this.loadSources('map',callback)}};return this;},getMap : function(alias) {if (alias in this.maps) return this.maps[alias];return eReport('map ['+alias+'] not exist')},whenMapReady : function(alias,callback){this.defset[alias].done(callback)},fixMapSize: function(alias) {var target = this.maps[alias];if (!target) return;target.map.invalidateSize()},initFullscreenButtons : function() {var basic_class = this.names.bigmap_buttons_class;var active_class = this.names.bigmap_buttons_active_class;var flag_class = this.names.bigmap_buttons_init_class;var that = this;$('.'+basic_class).not('.'+flag_class).addClass(flag_class).on('click',function(e){e.stopPropagation();var fullscreen_is_active = $(this).hasClass(active_class);var scrolltop = window.pageYOffset;$('.'+basic_class).toggleClass(active_class,!fullscreen_is_active);$('.b-global-wrapper').removeAttr('style').toggleClass('s-overlay-disable s-overlay-map',fullscreen_is_active).toggleClass('s-overlay-enable s-overlay-map',!fullscreen_is_active);if (!fullscreen_is_active) {var alias_from='main';var alias_to='fullscreen';that.createMap(alias_to);that.scrolltop_saved = scrolltop;} else {var alias_from='fullscreen';var alias_to='main';};if (that.maps[alias_to]) {that.whenMapReady(alias_to, function(){that.fixMapSize(alias_to)})};if(that.maps['main']){that.whenMapReady(alias_to, function(){that.map2map(alias_from, alias_to)})};if(alias_from==='fullscreen' && that.scrolltop_saved)window.scrollTo(0,that.scrolltop_saved);$(window).resize()})}};BlockStatHandler = {console_log : false,scroll_timeout : 300,display_timeout : 3000,send_timeout : 10000,display_count : 1,tracked_blocks : {},result:{'displayed':[],'clicked':[]},names : {block_class : 'js-tracking-blockstat',tracking_type_attr : 'data-blockstat-type',block_id_attr : 'data-blockstat-id',init_class : 's-blockstat-init',off_class : 's-blockstat-off'},Block : function(handler,data){this.handler = handler;this.data = data;this.init()},init : function(){this.calcViewportSize();var that = this;$('.'+this.names.block_class).not('.'+this.names.init_class).not('.'+this.names.off_class).each(function(){var t = $(this);t.addClass(that.names.init_class);var block_id = t.attr(that.names.block_id_attr);if (!block_id) {console.log('missed block_id for tracking blockstat',t);return true;};var tracking_type=t.attr(that.names.tracking_type_attr)|| 'all';that.tracked_blocks[block_id] = new that.Block(that,{container : t,id : block_id,click_tracking: tracking_type==='click' || tracking_type==='all',display_tracking: tracking_type==='display' || tracking_type==='all'})});$(window).on('resize',function(){that.calcViewportSize()});$(window).on('scroll',function(){clearTimeout(that.timer);if (!that.display_count) return;that.timer = setTimeout(function(){ that.calcBlockPositions()},that.scroll_timeout)});$(window).on('hashchange',function(){that.calcBlockPositions()});setInterval(function(){ that.sendStat(true)},this.send_timeout);$(window).on('unload',function(){that.sendStat(false)})},removeBlockFromTracking : function(elem){if (!elem.hasClass(this.names.init_class)) return;var block_id = elem.attr(this.names.block_id_attr);if (!block_id) return;delete(this.tracked_blocks[block_id]);elem.off('click').removeClass(this.names.init_class).addClass(this.names.off_class)},calcViewportSize : function(){this.viewport_height = $(window).innerHeight()},calcBlockPositions : function(){this.display_count = 0;for (var key in this.tracked_blocks) {var block = this.tracked_blocks[key];if (block.data.display_tracking) {block.calcPosition();this.display_count++;}}},log : function(event_type, block_id){if (this.console_log) console.log(event_type, block_id);this.result[event_type].push(block_id)},sendStat : function(async){var send_data = $.extend({},this.result);var empty_flag = true;for (var event_type in send_data) {if (!send_data[event_type].length) {delete send_data[event_type];} else {empty_flag = false;};this.result[event_type] = [];};if (empty_flag) return;if(this.console_log)console.log('send BlockStat',send_data);$.ajax({type: 'POST',url:'/remotes/tracker-blockstat',data: send_data,async: async})}};BlockStatHandler.Block.prototype = {size : {},init : function(){if (this.data.click_tracking) this.addClickEvents();if (this.data.display_tracking) this.calcPosition()},addClickEvents: function(){var that = this;this.data.container.one('click',function(){that.handler.log('clicked',that.data.id);that.data.display_tracking = false;that.data.click_tracking = false;})},calcSizes : function(){this.size.height = this.data.container.visibleHeight();if (!this.size.height) return false;this.size.width = this.data.container.visibleWidth();return this.size.width ? true : false;},isVisible : function(){if (!this.calcSizes()) return false;var offset_top = MainLib.getScrollTop(this.data.container,false);return offset_top >= 0 && offset_top + this.size.height <= this.handler.viewport_height;},calcPosition : function(){if (this.isVisible()) {var that = this;clearTimeout(this.timer);this.timer = setTimeout(function(){that.calcPositionAfterDelay()},this.handler.display_timeout)}},calcPositionAfterDelay : function(){if (this.isVisible()) {this.handler.log('displayed',this.data.id);this.data.display_tracking = false;}}};InnerAdvertHandler = {names : {inner_ad_class : 's-inner-ready',ad_point_class : 'a--d--point',adv_selector : 'div[id^=adfox_], ins.adsbygoogle, div[id^=yandex_rtb], .t-adv-demo',detector_selector : '.b-detector-a-d-b div',message_block_value : 'inner-ad-block'},init: function(){if (this.detectAdblock() && !ProjectHandler.isMobile()) this.replaceLeftAdForArticlesPreview();if (!this.defineAdPoints().length) return;this.start();var that = this;window.onmessage = function(event){if (!event.data) return;var data;if(typeof event.data==='object'){data = event.data;} else return;if (data.block !== that.names.message_block_value) return;var point = that.ad_points.filter('[data-name="'+ data.name +'"]');if (!point.length) return false;if(data.event==='load')that.initInnerAd(point,data);else if(data.event==='click')that.clickInnerAd(point,data)};},detectAdblock : function(){if (this.adblock_status===undefined) {var control_elem = $(this.names.detector_selector);if(!control_elem.length)eReport('element for detect adblock is not exists!');this.adblock_status = control_elem.width() ? false : true;};return this.adblock_status},defineAdPoints : function() {this.ad_points=$('.'+this.names.ad_point_class+'.'+this.names.inner_ad_class);return this.ad_points;},replaceLeftAdForArticlesPreview : function(){var name=MainLib.getJsConfig('pagename');if(name==='index')return;AjaxHandler.runScript('js_append_aside_articles')},initInnerAd : function(point,data){var handler = BlockStatHandler;var a = handler.names.block_class;if (point.hasClass(a)) return;point.addClass(a).attr(handler.names.block_id_attr,data['tracking_id']+'@'+data['tracking_num']);handler.init()},clickInnerAd : function(point,data){point.click();if(data['name'].indexOf('ipoteka')!==-1){return;};location.href=data['target_url'];},removeInnerAd: function (point){point.removeClass(this.names.inner_ad_class);point.off('click');this.defineAdPoints();BlockStatHandler.removeBlockFromTracking(point)},detectAdvert : function(point) {var ad_blocks = point.children(this.names.adv_selector);if (!ad_blocks.length) return false;var result = false;ad_blocks.each(function(){if ($(this).visibleHeight()) result = true;});return result;},counter : 30,start: function() {var that = this;this.interval = setInterval(function(){that.tick()},1000)},tick : function(){this.counter--;if (!this.counter || !this.ad_points.length) this.stop();var that = this;this.ad_points.each(function(){var point = $(this);if (that.detectAdvert(point)) {that.removeInnerAd(point)}})},stop: function() {clearInterval(this.interval)}};AdfoxWidthFix = {init: function(ids){for (var i in ids) {new this.Block(ids[i])}},Block :function(id) {this.id = id;this.start()}};AdfoxWidthFix.Block.prototype = {id : null,counter: 0,start: function() {this.elem=$('.t-content-2column-main').find('#'+this.id);if (!this.elem.length) return;var that = this;this.interval = setInterval(function(){that.tick()},1000)},tick : function(){this.counter++;if (this.counter>10) this.stop();if(!this.elem.children('*').length)return;var child = this.elem.find('*[style*="width"],*[width="970"]').not('[style*="max-width"]').eq(0);if (!child.length) return;var width = child.width();if (width>=771) {this.elem.css({'transform':'scale(0.794)','margin' : '-20px -100px','margin-top' : '-20px','margin-bottom' : '-20px','margin-left' : '-100px','margin-right' : '-100px'})} else {};this.stop()},stop: function() {clearInterval(this.interval)}};$(function(){ClockHandler.init();MainMenuHandler.init();MainSearchDisplayHandler.init();MainSearchKitsHandler.init();ProjectHandler.initHandlersUI();MapsHandler.initFullscreenButtons();PageMenuBobberHandler.init();AsideBobberHandler.init();PagemenuHandler.init();ProjectHandler.init();BlockStatHandler.init();AdfoxWidthFix.init(['adfox_153844313180777971','adfox_15389863958605869']);FramesetAdFix.start();if (MainLib.getCookie4AlertOnNewPage) {var data = MainLib.getCookie4AlertOnNewPage();if (data) ModalHandler.alert(data.msg, data.header, data.class)};InnerAdvertHandler.init()});FramesetAdFix = {counter: 20,interval: 500,selector : '.b-global-wrapper,.b-vd-content',start: function() {this.elems = $(this.selector);if (!this.elems.length) return;var that = this;this.interval = setInterval(function(){that.tick()},that.interval)},tick : function(){this.counter--;if (this.counter<0) this.stop();this.elems.removeAttr('style')},stop: function() {clearInterval(this.interval)}};